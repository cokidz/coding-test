<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beë™ì‚¬ ì§ˆë¬¸ ë§ˆìŠ¤í„°: 9ì„¸ ì˜ì–´ íƒí—˜</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #FDFBF7; color: #4A4A4A; }
        .chart-container { position: relative; width: 100%; max-width: 500px; margin: auto; height: 300px; }
        .tab-active { border-bottom: 4px solid #F59E0B; color: #B45309; font-weight: 700; }
        .tab-inactive { color: #9CA3AF; font-weight: 500; }
        .btn-primary { background-color: #F59E0B; color: white; transition: all 0.2s; }
        .btn-primary:hover { background-color: #D97706; transform: translateY(-2px); }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* ì½ê¸° ë¯¸ì…˜ ì„ íƒ íš¨ê³¼ */
        .reading-selected { border-color: #F59E0B !important; background-color: #FFFBEB !important; transform: scale(1.02); }
        .reading-matched { border-color: #10B981 !important; background-color: #ECFDF5 !important; color: #047857; }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

<div class="max-w-4xl mx-auto bg-white rounded-3xl shadow-xl overflow-hidden min-h-[80vh] flex flex-col">
    <header class="bg-[#FFF8E1] p-6 border-b border-orange-100 flex flex-col md:flex-row justify-between items-center">
        <div>
            <h1 class="text-2xl md:text-3xl font-bold text-amber-600">Beë™ì‚¬ ì§ˆë¬¸Â·ë‹µë³€ ë§ˆìŠ¤í„°</h1>
            <p class="text-sm text-gray-500 mt-1">9ì„¸ë¥¼ ìœ„í•œ ì§ˆë¬¸ê³¼ ë‹µë³€ ì™„ì „ ì •ë³µ!</p>
        </div>
        <div id="user-display" class="hidden mt-4 md:mt-0 flex items-center bg-white px-4 py-2 rounded-full shadow-sm">
            <span class="text-2xl mr-2">ì•ˆë…•</span>
            <span id="display-name" class="font-bold text-gray-700">ì¹œêµ¬</span>
            <span class="ml-2 text-xs text-gray-400">íƒí—˜ê°€</span>
        </div>
    </header>

    <nav class="flex border-b border-gray-100 text-lg overflow-x-auto" id="main-nav">
        <button onclick="switchTab('intro')" id="tab-intro" class="flex-1 py-4 px-6 text-center whitespace-nowrap tab-active">ì‹œì‘í•˜ê¸°</button>
        <button onclick="switchTab('listening')" id="tab-listening" class="flex-1 py-4 px-6 text-center whitespace-nowrap tab-inactive cursor-not-allowed" disabled>ğŸ‘‚ ë“£ê¸° ë¯¸ì…˜</button>
        <button onclick="switchTab('reading')" id="tab-reading" class="flex-1 py-4 px-6 text-center whitespace-nowrap tab-inactive cursor-not-allowed" disabled>ğŸ“š ì½ê¸° ë¯¸ì…˜</button>
        <button onclick="switchTab('writing')" id="tab-writing" class="flex-1 py-4 px-6 text-center whitespace-nowrap tab-inactive cursor-not-allowed" disabled>âœï¸ ì“°ê¸° ë¯¸ì…˜</button>
        <button onclick="switchTab('report')" id="tab-report" class="flex-1 py-4 px-6 text-center whitespace-nowrap tab-inactive cursor-not-allowed" disabled>ğŸ† ê²°ê³¼</button>
    </nav>

    <main class="flex-grow p-6 md:p-8 bg-[#FAFAFA] relative">

        <section id="view-intro" class="fade-in max-w-lg mx-auto text-center pt-10">
            <div class="text-6xl mb-6">ğŸ¦</div>
            <h2 class="text-2xl font-bold mb-4">ì§ˆë¬¸ ë§ˆìŠ¤í„°ì— ë„ì „!</h2>
            <p class="text-gray-600 mb-8 leading-relaxed">
                Beë™ì‚¬ë¡œ ì§ˆë¬¸í•˜ê³  ë‹µí•˜ëŠ” ê±¸<br>ì™„ë²½í•˜ê²Œ ë°°ì›Œë³¼ ê±°ì˜ˆìš”!<br>3ê°€ì§€ ë¯¸ì…˜ìœ¼ë¡œ ì¬ë°Œê²Œ í•´ë³´ì
            </p>
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 mb-8">
                <label class="block text-left text-sm font-bold text-gray-500 mb-2">ì´ë¦„ì„ ì•Œë ¤ì¤˜!</label>
                <input type="text" id="username-input" class="w-full text-lg p-3 border-2 border-amber-200 rounded-xl focus:outline-none focus:border-amber-500" placeholder="ì˜ˆ: í•˜ì¤€">
            </div>
            <button onclick="startMission()" class="w-full btn-primary py-4 rounded-xl text-xl font-bold shadow-lg">
                ë¯¸ì…˜ ì‹œì‘í•˜ê¸° ğŸš€
            </button>
        </section>

        <section id="view-listening" class="hidden fade-in">
            <h2 class="text-xl font-bold text-amber-700 mb-2">ë¯¸ì…˜ 1: ë“£ê³  ë§ëŠ” ë‹µ ê³ ë¥´ê¸° (ì´ 5ë¬¸ì œ)</h2>
            <p class="text-sm text-gray-500 mb-6">ìŠ¤í”¼ì»¤ë¥¼ ëˆŒëŸ¬ ì§ˆë¬¸ì„ ë“£ê³ , ì•Œë§ì€ ëŒ€ë‹µì„ ì„ íƒí•˜ì„¸ìš”.</p>
            
            <div id="listening-container" class="space-y-6"></div>
            
            <div class="mt-10 text-right">
                <button onclick="completeSection('listening','reading')" class="bg-gray-800 text-white px-8 py-3 rounded-xl font-bold hover:bg-black transition">ë‹¤ìŒ ë¯¸ì…˜ ğŸ‘‰</button>
            </div>
        </section>

        <section id="view-reading" class="hidden fade-in">
            <h2 class="text-xl font-bold text-amber-700 mb-2">ë¯¸ì…˜ 2: ì§ê¿ ì°¾ê¸° (ì´ 5ë¬¸ì œ)</h2>
            <p class="text-sm text-gray-500 mb-6">ì™¼ìª½ì˜ <b>ì§ˆë¬¸</b>ì„ ë¨¼ì € ëˆ„ë¥´ê³ , ì˜¤ë¥¸ìª½ì—ì„œ ì•Œë§ì€ <b>ëŒ€ë‹µ</b>ì„ ì°¾ì•„ ëˆŒëŸ¬ì£¼ì„¸ìš”!</p>
            
            <div class="grid grid-cols-2 gap-4 md:gap-12 max-w-4xl mx-auto">
                <div class="space-y-4">
                    <h3 class="font-bold text-center text-gray-400 mb-2">ì§ˆë¬¸ (Questions)</h3>
                    <div id="questions-list" class="space-y-4"></div>
                </div>
                <div class="space-y-4">
                    <h3 class="font-bold text-center text-gray-400 mb-2">ë‹µë³€ (Answers)</h3>
                    <div id="answers-list" class="space-y-4"></div>
                </div>
            </div>
            
            <div class="mt-6 text-center">
                 <button onclick="resetReading()" class="text-sm text-gray-400 underline hover:text-gray-600">ë‹¤ì‹œ ì—°ê²°í•˜ê¸°</button>
            </div>

            <div class="mt-10 text-right">
                <button onclick="completeSection('reading','writing')" class="bg-gray-800 text-white px-8 py-3 rounded-xl font-bold hover:bg-black transition">ë‹¤ìŒ ë¯¸ì…˜ ğŸ‘‰</button>
            </div>
        </section>

        <section id="view-writing" class="hidden fade-in">
            <h2 class="text-xl font-bold text-amber-700 mb-2">ë¯¸ì…˜ 3: ì§ì ‘ ì¨ë³´ê¸° (ì´ 5ë¬¸ì œ)</h2>
            <p class="text-sm text-gray-500 mb-6">ë¹ˆì¹¸ì— ì •ë‹µì„ ì ê±°ë‚˜, ë‹¨ì–´ë¥¼ ìˆœì„œëŒ€ë¡œ ì¨ë³´ì„¸ìš”.</p>
            
            <div id="writing-container" class="space-y-8 max-w-2xl mx-auto"></div>
            
            <div class="mt-10 text-right">
                <button onclick="finishQuiz()" class="btn-primary px-8 py-3 rounded-xl font-bold text-lg shadow-md">ê²°ê³¼ ë³´ê¸° ğŸ†</button>
            </div>
        </section>

        <section id="view-report" class="hidden fade-in">
            <div class="text-center mb-8">
                <h2 class="text-3xl font-bold text-gray-800 mb-2">íƒí—˜ ê²°ê³¼</h2>
                <p id="score-message" class="text-lg text-gray-600">ì±„ì  ì¤‘...</p>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
                <div class="bg-white p-6 rounded-2xl shadow-sm border text-center flex flex-col items-center">
                    <div class="chart-container"><canvas id="scoreChart"></canvas></div>
                    <div class="mt-4">
                        <p class="text-4xl font-bold text-amber-600" id="final-score">0ì </p>
                        <p class="text-xs text-gray-400">ì´ 150ì  ë§Œì </p>
                    </div>
                </div>
                <div class="space-y-6">
                    <div class="bg-blue-50 p-6 rounded-xl border border-blue-100">
                        <h3 class="font-bold text-blue-800 mb-3">ğŸ’¡ ì„ ìƒë‹˜ í”¼ë“œë°±</h3>
                        <p id="feedback-text" class="text-blue-900 leading-relaxed"></p>
                    </div>
                    <div class="bg-white p-5 rounded-xl border border-gray-100">
                        <h3 class="font-bold text-gray-700 mb-4">ì˜ì—­ë³„ ì ìˆ˜</h3>
                        <div class="space-y-4 text-sm">
                            <div>
                                <div class="flex justify-between mb-1"><span>ë“£ê¸° (Listening)</span><span id="progress-listening-val">0/50</span></div>
                                <div class="w-full bg-gray-200 rounded-full h-3"><div id="progress-listening" class="bg-green-500 h-3 rounded-full" style="width:0%"></div></div>
                            </div>
                            <div>
                                <div class="flex justify-between mb-1"><span>ì½ê¸° (Reading)</span><span id="progress-reading-val">0/50</span></div>
                                <div class="w-full bg-gray-200 rounded-full h-3"><div id="progress-reading" class="bg-blue-500 h-3 rounded-full" style="width:0%"></div></div>
                            </div>
                            <div>
                                <div class="flex justify-between mb-1"><span>ì“°ê¸° (Writing)</span><span id="progress-writing-val">0/50</span></div>
                                <div class="w-full bg-gray-200 rounded-full h-3"><div id="progress-writing" class="bg-amber-500 h-3 rounded-full" style="width:0%"></div></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="text-center mt-12">
                <button onclick="location.reload()" class="text-gray-400 underline hover:text-gray-600 text-sm">ì²˜ìŒë¶€í„° ë‹¤ì‹œ ë„ì „í•˜ê¸°</button>
            </div>
        </section>
    </main>
</div>

<script>
// --- ë°ì´í„° ---
const quizData = {
    listening: [
        {id:1, audio:"Are you a student?", question:"ì´ ì§ˆë¬¸ì— ë§ëŠ” ëŒ€ë‹µì€?", options:["Yes, I am.","Yes, he is.","No, they aren't."], correct:0},
        {id:2, audio:"Is your mother at home?", question:"ì´ ì§ˆë¬¸ì— ë§ëŠ” ëŒ€ë‹µì€?", options:["Yes, I am.","No, she's not.","Yes, it is."], correct:1},
        {id:3, audio:"What's your name?", question:"ì´ë¦„ì„ ë¬¼ì–´ë³¼ ë•Œ ëŒ€ë‹µì€?", options:["I'm Tom.","I'm nine years old.","I'm happy."], correct:0},
        {id:4, audio:"Where are you from?", question:"ì¶œì‹ ì„ ë¬¼ì–´ë³¼ ë•Œ ëŒ€ë‹µì€?", options:["Korea.","Blue.","Fine, thanks."], correct:0},
        {id:5, audio:"How are your parents?", question:"ë¶€ëª¨ë‹˜ ì•ˆë¶€ë¥¼ ë¬¼ì„ ë•Œ ëŒ€ë‹µì€?", options:["I'm fine.","They're fine.","Yes, they are."], correct:1}
    ],
    reading: [ 
        {id:6, qText:"Are you married?", aId: "A", aText:"No, I'm not."},
        {id:7, qText:"Is she a teacher?", aId: "B", aText:"Yes, she is."},
        {id:8, qText:"What color is your car?", aId: "C", aText:"Red."},
        {id:9, qText:"How are your parents?", aId: "D", aText:"They're fine."},
        {id:10, qText:"Where are you from?", aId: "E", aText:"I'm from Korea."}
    ],
    writing: [
        {id:11, question:"Are you hungry?", hint:"(Yes) â†’", correct:["Yes, I am", "yes i am"]},
        {id:12, question:"Is it cold today?", hint:"(No) â†’", correct:["No, it isn't", "no it isn't", "No, it is not", "No, it's not"]},
        {id:13, question:"Are your hands cold?", hint:"(Yes) â†’", correct:["Yes, they are", "yes they are"]},
        {id:14, words:["you","are","student","a"], correct:["Are you a student", "are you a student"]},
        {id:15, words:["name","what","your","is"], correct:["What is your name", "what is your name"]}
    ]
};

// --- ìƒíƒœ ê´€ë¦¬ ---
let state = {
    username: "",
    scores: {listening:0, reading:0, writing:0},
    userAnswers: {
        listening:{}, 
        reading:{}, // {questionID: answerID} í˜•íƒœ
        writing:{}
    },
    readingSelection: { q: null } // í˜„ì¬ ì„ íƒëœ ì§ˆë¬¸ ID
};

// --- ë„¤ë¹„ê²Œì´ì…˜ ---
function switchTab(tabId){ 
    ['intro','listening','reading','writing','report'].forEach(id => {
        document.getElementById('view-'+id).classList.add('hidden');
        const btn = document.getElementById('tab-'+id);
        if(btn) {
            btn.classList.remove('tab-active');
            btn.classList.add('tab-inactive');
        }
    });
    
    document.getElementById('view-'+tabId).classList.remove('hidden');
    const activeBtn = document.getElementById('tab-'+tabId);
    if(activeBtn) {
        activeBtn.classList.remove('tab-inactive');
        activeBtn.classList.add('tab-active');
        activeBtn.disabled = false;
        activeBtn.classList.remove('cursor-not-allowed');
    }
}

function startMission(){
    const name = document.getElementById('username-input').value.trim();
    if(!name) return alert("ì´ë¦„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”!");
    state.username = name;
    document.getElementById('display-name').textContent = name;
    document.getElementById('user-display').classList.remove('hidden');
    
    renderListening();
    switchTab('listening');
}

function completeSection(curr, next){
    // ê°„ë‹¨í•œ ìœ íš¨ì„± ê²€ì‚¬ (ê°œìˆ˜ ì²´í¬)
    let count = 0;
    if(curr === 'listening') count = Object.keys(state.userAnswers.listening).length;
    if(curr === 'reading') count = Object.keys(state.userAnswers.reading).length;
    
    if(count < 5) {
        alert("ëª¨ë“  ë¬¸ì œë¥¼ í’€ì–´ì£¼ì„¸ìš”! ğŸ¥º");
        return;
    }
    
    if(next === 'reading') renderReading();
    if(next === 'writing') renderWriting();
    switchTab(next);
}

// --- 1. ë“£ê¸° (Listening) ---
function playAudio(text){
    if('speechSynthesis' in window){
        window.speechSynthesis.cancel();
        const utter = new SpeechSynthesisUtterance(text);
        utter.lang = 'en-US'; 
        utter.rate = 0.8; 
        speechSynthesis.speak(utter);
    } else {
        alert("ë¸Œë¼ìš°ì €ê°€ ìŒì„±ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
    }
}

function renderListening(){
    const container = document.getElementById('listening-container');
    container.innerHTML = quizData.listening.map((q,i)=>`
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
            <div class="flex flex-col md:flex-row items-center gap-6">
                <div class="flex flex-col items-center">
                    <span class="text-xs font-bold text-amber-600 mb-2">ë¬¸ì œ ${i+1}</span>
                    <button onclick="playAudio('${q.audio.replace(/'/g,"\\'")}')" class="w-16 h-16 bg-amber-500 rounded-full text-white hover:bg-amber-600 shadow-lg flex items-center justify-center transform transition hover:scale-105">
                        <span class="text-2xl">ğŸ”Š</span>
                    </button>
                    <p class="text-xs text-gray-400 mt-2">ë“£ê¸°</p>
                </div>
                <div class="flex-1 w-full space-y-3">
                    <p class="font-bold text-gray-700 mb-2">${q.question}</p>
                    ${q.options.map((opt,idx)=>`
                        <button onclick="selectListening(${q.id},${idx},this)" class="listen-opt-${q.id} w-full text-left p-4 rounded-xl border-2 transition-all ${state.userAnswers.listening[q.id]===idx ? 'bg-amber-500 text-white border-amber-500' : 'border-gray-200 hover:border-amber-300 hover:bg-amber-50'}">
                            ${opt}
                        </button>
                    `).join('')}
                </div>
            </div>
        </div>
    `).join('');
}

function selectListening(qId, optIdx, el){
    state.userAnswers.listening[qId] = optIdx;
    // UI ì—…ë°ì´íŠ¸
    document.querySelectorAll(`.listen-opt-${qId}`).forEach(b => {
        b.classList.remove('bg-amber-500','text-white','border-amber-500');
        b.classList.add('border-gray-200');
    });
    el.classList.remove('border-gray-200','hover:bg-amber-50');
    el.classList.add('bg-amber-500','text-white','border-amber-500');
}

// --- 2. ì½ê¸° (Reading) - ë¡œì§ ì™„ì „ ìˆ˜ì • ---
function renderReading(){
    const qList = document.getElementById('questions-list');
    const aList = document.getElementById('answers-list');
    
    // ë‹µë³€ ì„ê¸°
    // ë‹µë³€ ëª©ë¡ì„ ìƒì„±í•  ë•Œ, ì›ë³¸ ë°ì´í„°ì˜ ID(id)ì™€ ë‹µë³€ ë‚´ìš©(aText)ì„ ë§¤í•‘í•˜ì—¬ ë Œë”ë§í•´ì•¼ í•¨.
    // quizData.readingì˜ ê° í•­ëª©ì€ í•˜ë‚˜ì˜ ë¬¸ì œ(ì§ˆë¬¸+ë‹µë³€) ì„¸íŠ¸ì„.
    // ë”°ë¼ì„œ ë‹µë³€ ëª©ë¡ì€ ì´ ì„¸íŠ¸ë“¤ì„ ì„ì–´ì„œ ë³´ì—¬ì£¼ë˜, í´ë¦­ ì‹œ í•´ë‹¹ ë‹µë³€ì´ ì†í•œ ë¬¸ì œì˜ IDë¥¼ ì¶”ì í•  ìˆ˜ ìˆì–´ì•¼ í•¨.
    const shuffledAnswers = [...quizData.reading].sort(() => Math.random() - 0.5);

    qList.innerHTML = quizData.reading.map(q => `
        <button id="q-btn-${q.id}" onclick="clickQuestion(${q.id})" class="w-full text-left p-4 rounded-xl border-2 border-gray-200 hover:border-amber-300 transition-all bg-white relative">
            <span class="font-bold text-gray-700">Q. ${q.qText}</span>
            <span id="q-check-${q.id}" class="absolute right-4 top-4 text-green-500 hidden">âœ”</span>
        </button>
    `).join('');

    aList.innerHTML = shuffledAnswers.map(a => `
        <button id="a-btn-${a.id}" onclick="clickAnswer(${a.id})" class="w-full text-left p-4 rounded-xl border-2 border-gray-200 hover:border-amber-300 transition-all bg-white">
            <span class="font-bold text-gray-600">${a.aText}</span>
        </button>
    `).join('');
}

function clickQuestion(id) {
    // ì´ë¯¸ ì—°ê²°ëœ ì§ˆë¬¸ì´ë©´ ë¬´ì‹œí•˜ì§€ ì•Šê³ , ë‹¤ì‹œ ì„ íƒ ê°€ëŠ¥í•˜ë„ë¡ (ìˆ˜ì •) í•  ìˆ˜ë„ ìˆì§€ë§Œ, 
    // ì—¬ê¸°ì„œëŠ” ê°„ë‹¨í•˜ê²Œ ê¸°ì¡´ ì„ íƒì„ í•´ì œí•˜ê³  ìƒˆë¡œ ì„ íƒí•˜ë„ë¡ í•¨.
    
    // ì´ì „ì— ì„ íƒëœ ì§ˆë¬¸ ìŠ¤íƒ€ì¼ í•´ì œ
    if(state.readingSelection.q) {
        const prevBtn = document.getElementById(`q-btn-${state.readingSelection.q}`);
        if(prevBtn && !state.userAnswers.reading[state.readingSelection.q]) {
            prevBtn.classList.remove('reading-selected');
        }
    }

    state.readingSelection.q = id;
    const btn = document.getElementById(`q-btn-${id}`);
    btn.classList.add('reading-selected');
}

function clickAnswer(targetAnswerId) { // targetAnswerIdëŠ” í•´ë‹¹ ë‹µë³€ì´ ì›ë˜ ì†í•´ìˆë˜ ë¬¸ì œì˜ ID
    if (!state.readingSelection.q) {
        alert("ì™¼ìª½ì˜ ì§ˆë¬¸ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”!");
        return;
    }

    const qId = state.readingSelection.q;
    
    // ì •ë‹µ ì €ì¥ (ìœ ì €ê°€ qId ì§ˆë¬¸ì— ëŒ€í•´ targetAnswerId ë‹µë³€ì„ ì„ íƒí•¨)
    // ì£¼ì˜: ì—¬ê¸°ì„œ targetAnswerIdëŠ” ë‹µë³€ í…ìŠ¤íŠ¸ê°€ ì†í•œ ë¬¸ì œì˜ IDì…ë‹ˆë‹¤.
    state.userAnswers.reading[qId] = targetAnswerId; 

    // UI ë°˜ì˜ (ì§ˆë¬¸ê³¼ ë‹µë³€ ëª¨ë‘ 'ì—°ê²°ë¨' ìŠ¤íƒ€ì¼ ì ìš©)
    document.getElementById(`q-btn-${qId}`).classList.remove('reading-selected');
    document.getElementById(`q-btn-${qId}`).classList.add('reading-matched');
    document.getElementById(`q-check-${qId}`).classList.remove('hidden');
    
    // ë‹µë³€ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì ìš© (ì´ ë‹µë³€ ë²„íŠ¼ì€ targetAnswerIdë¥¼ ê°€ì§)
    // ê¸°ì¡´ì— ì´ ë‹µë³€ì´ ë‹¤ë¥¸ ì§ˆë¬¸ì— ì—°ê²°ë˜ì–´ ìˆì—ˆë‹¤ë©´ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”ê°€ í•„ìš”í•˜ì§€ë§Œ, 
    // ê°„ë‹¨í•œ ë¡œì§ì„ ìœ„í•´ 'ë§ˆì§€ë§‰ ì„ íƒ'ì„ ë³´ì—¬ì¤Œ.
    
    // ëª¨ë“  ë‹µë³€ ë²„íŠ¼ì˜ ìŠ¤íƒ€ì¼ì„ í™•ì¸í•˜ì—¬, í˜„ì¬ ì§ˆë¬¸ì— ì—°ê²°ëœ ê²ƒë§Œ ê°•ì¡°
    document.querySelectorAll('[id^="a-btn-"]').forEach(btn => {
        // ë§Œì•½ ì´ì „ì— ì´ ë²„íŠ¼ì´ ì„ íƒë˜ì—ˆì—ˆë‹¤ë©´ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™” (ë‹¨ìˆœí™”)
        if(btn.id === `a-btn-${targetAnswerId}`) {
            btn.classList.add('reading-matched');
        }
    });

    // ì„ íƒ ì´ˆê¸°í™”
    state.readingSelection.q = null;
}

function resetReading() {
    state.userAnswers.reading = {};
    state.readingSelection.q = null;
    renderReading();
}


// --- 3. ì“°ê¸° (Writing) ---
function renderWriting(){
    const container = document.getElementById('writing-container');
    container.innerHTML = quizData.writing.map((q,i) => {
        if(q.words) {
            // ë‹¨ì–´ ë°°ì—´ ë¬¸ì œ
            return `
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                <span class="inline-block bg-amber-100 text-amber-800 text-xs px-2 py-1 rounded-full mb-3 font-bold">ë¬¸ì œ ${i+11}</span>
                <p class="text-lg font-bold mb-4 text-gray-800">ë‹¨ì–´ë¥¼ ìˆœì„œëŒ€ë¡œ ë°°ì—´í•´ì„œ ì§ˆë¬¸ì„ ë§Œë“œì„¸ìš”.</p>
                <div class="flex flex-wrap justify-center gap-2 mb-6 p-4 bg-gray-50 rounded-xl">
                    ${q.words.map(w => `<span class="bg-white border-2 border-amber-200 px-3 py-2 rounded-lg font-bold text-amber-700 shadow-sm">${w}</span>`).join('')}
                </div>
                <input type="text" oninput="handleWritingInput(${q.id}, this.value)" class="w-full p-4 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-amber-500 text-lg font-mono placeholder-gray-300 transition" placeholder="ì •ë‹µì„ ì ì–´ë³´ì„¸ìš”">
            </div>`;
        } else {
            // ë¹ˆì¹¸/ë‹µë³€ ë¬¸ì œ
            return `
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                <span class="inline-block bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full mb-3 font-bold">ë¬¸ì œ ${i+11}</span>
                <p class="text-xl font-bold mb-2 text-gray-800">${q.question}</p>
                <p class="text-sm text-gray-500 mb-4">íŒíŠ¸: ${q.hint}</p>
                <input type="text" oninput="handleWritingInput(${q.id}, this.value)" class="w-full p-4 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-amber-500 text-lg font-mono placeholder-gray-300 transition" placeholder="ë‹µë³€ì„ ì ì–´ë³´ì„¸ìš”">
            </div>`;
        }
    }).join('');
}

function handleWritingInput(id, val) {
    state.userAnswers.writing[id] = val;
}

// --- ì±„ì  ë° ê²°ê³¼ (Scoring) ---
function finishQuiz(){
    let scoreL = 0, scoreR = 0, scoreW = 0;
    
    // 1. ë“£ê¸° ì±„ì 
    quizData.listening.forEach(q => {
        if(state.userAnswers.listening[q.id] === q.correct) scoreL += 10;
    });

    // 2. ì½ê¸° ì±„ì 
    // userAnswers.reading = { questionId: answerId }
    // answerIdëŠ” í•´ë‹¹ ë‹µë³€ì´ ì›ë˜ ì†í•œ ë¬¸ì œì˜ IDì™€ ê°™ìŒ (ë°ì´í„° êµ¬ì¡°ìƒ)
    quizData.reading.forEach(q => {
        const userAnswer = state.userAnswers.reading[q.id];
        if(userAnswer === q.id) { // ì§ˆë¬¸IDì™€ ë‹µë³€(ì˜ ì›ë³¸ì§ˆë¬¸ID)ê°€ ê°™ìœ¼ë©´ ì •ë‹µ
            scoreR += 10;
        }
    });

    // 3. ì“°ê¸° ì±„ì 
    quizData.writing.forEach(q => {
        const user = (state.userAnswers.writing[q.id] || "").trim();
        // ì •ê·œí™”: ì†Œë¬¸ìë¡œ ë³€í™˜, ë§ˆì¹¨í‘œ/ë¬¼ìŒí‘œ ì œê±°
        const normalizedUser = user.toLowerCase().replace(/[.?]/g, "").replace(/\s+/g, " ");
        const isCorrect = q.correct.some(ans => {
            const normalizedAns = ans.toLowerCase().replace(/[.?]/g, "").replace(/\s+/g, " ");
            return normalizedAns === normalizedUser;
        });
        
        if(isCorrect) scoreW += 10;
    });

    const total = scoreL + scoreR + scoreW;
    state.scores = { listening: scoreL, reading: scoreR, writing: scoreW };

    // ê²°ê³¼ í™”ë©´ ë Œë”ë§
    document.getElementById('final-score').textContent = total + "ì ";
    
    // í”„ë¡œê·¸ë ˆìŠ¤ ë°”
    updateProgress('listening', scoreL);
    updateProgress('reading', scoreR);
    updateProgress('writing', scoreW);

    // í”¼ë“œë°± ë©”ì‹œì§€
    const fb = document.getElementById('feedback-text');
    const msg = document.getElementById('score-message');
    
    if(total === 150){ 
        fb.innerHTML = `ìš°ì™€! <b>${state.username}</b> ì¹œêµ¬, ì •ë§ ëŒ€ë‹¨í•´ìš”! <br>Beë™ì‚¬ ì§ˆë¬¸ê³¼ ë‹µë³€ì„ ì™„ë²½í•˜ê²Œ ì´í•´í–ˆêµ°ìš”! ğŸ‰`; 
        msg.textContent = "ğŸ† ì™„ë²½í•´ìš”!"; 
    } else if(total >= 100){ 
        fb.innerHTML = `ì°¸ ì˜í–ˆì–´ìš” <b>${state.username}</b> ì¹œêµ¬! <br>ëŒ€ë¶€ë¶„ ë§ì·„ë„¤ìš”. í‹€ë¦° ë¬¸ì œë§Œ ë‹¤ì‹œ í•œë²ˆ í™•ì¸í•´ë³¼ê¹Œìš”? ğŸ‘`; 
        msg.textContent = "ğŸ˜ ì•„ì£¼ í›Œë¥­í•´ìš”!"; 
    } else { 
        fb.innerHTML = `ìˆ˜ê³ í–ˆì–´ìš” <b>${state.username}</b> ì¹œêµ¬! <br>ì•„ì§ ì¡°ê¸ˆ í—·ê°ˆë¦¬ëŠ” ê²Œ ìˆë‚˜ë´ìš”. ë‹¤ì‹œ í•œë²ˆ ì²œì²œíˆ í’€ì–´ë³´ë©´ ë‹¤ ë§ì„ ìˆ˜ ìˆì–´ìš”! ğŸŒ±`; 
        msg.textContent = "ğŸ’ª í˜ë‚´ì„¸ìš”!"; 
    }

    // ì°¨íŠ¸ ê·¸ë¦¬ê¸°
    const ctx = document.getElementById('scoreChart').getContext('2d');
    if(window.myChart) window.myChart.destroy();
    window.myChart = new Chart(ctx, {
        type: 'doughnut', 
        data: {
            labels: ['ë§ì€ ì ìˆ˜', 'ë¶€ì¡±í•œ ì ìˆ˜'], 
            datasets: [{
                data: [total, 150-total], 
                backgroundColor: ['#F59E0B', '#E5E7EB'], 
                borderWidth: 0
            }]
        },
        options: {
            responsive: true, 
            maintainAspectRatio: false,
            plugins: { legend: { display: false }, tooltip: {enabled: false} }, 
            cutout: '75%'
        }
    });

    switchTab('report');
}

function updateProgress(type, score) {
    const el = document.getElementById(`progress-${type}`);
    const val = document.getElementById(`progress-${type}-val`);
    el.style.width = `${(score/50)*100}%`;
    val.textContent = `${score}/50`;
}
</script>
</body>
</html>
